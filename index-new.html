<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-Profit Fund Accounting System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background-color: #2196F3;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .header-right-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .db-status-container, .consolidated-view-container, .entity-selector-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #db-status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            background-color: #f44336; /* Offline */
            color: white;
        }
        #db-status-indicator.online {
            background-color: #4CAF50; /* Online */
        }
        #consolidated-view-toggle {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        #entity-selector {
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: white;
            font-size: 0.9em;
            min-width: 180px;
        }
        .user-info {
            font-size: 0.9em;
        }
        .logout-button {
            background-color: #FFC107;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .logout-button:hover {
            background-color: #FFA000;
        }

        .main-content {
            display: flex;
            flex: 1;
        }
        .main-nav {
            background-color: #263238;
            color: white;
            width: 200px;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.95em;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background-color: #37474F;
        }
        .nav-item.active {
            background-color: #37474F;
            border-left-color: #2196F3;
            font-weight: bold;
        }
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .content-header h2 {
            margin: 0;
            color: #2196F3;
        }
        .action-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .action-button:hover {
            background-color: #43A047;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        .card-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 2em;
            font-weight: bold;
            color: #2196F3;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            font-size: 0.85em;
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        .data-table tbody tr:hover {
            background-color: #f9f9f9;
        }
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
        }
        .status-posted { background-color: #4CAF50; }
        .status-draft { background-color: #FFC107; }
        .status-void { background-color: #9E9E9E; }

        /* Settings Page Specific Styles */
        .settings-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .settings-section h3 {
            margin-top: 0;
            color: #2196F3;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .settings-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .settings-section input[type="text"],
        .settings-section input[type="email"],
        .settings-section select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .settings-section button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
        }
        .settings-section button:hover {
            background-color: #0b7dda;
        }

        /* Entity Hierarchy Visualization */
        .hierarchy-visualization {
            min-height: 300px;
            max-height: 600px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            background-color: #f9f9f9;
        }
        .hierarchy-node {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #ccc;
        }
        .entity-node {
            border-left-color: #2196F3;
            background-color: #e3f2fd;
        }
        .fund-node {
            border-left-color: #4CAF50;
            background-color: #e8f5e9;
        }
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background-color: rgba(255,255,255,0.5);
            border-radius: 3px;
        }
        .node-title {
            font-weight: bold;
            color: #333;
        }
        .node-children {
            margin-left: 20px;
            padding-left: 10px;
            border-left: 1px dashed #ccc;
        }
        .collapsed {
            display: none;
        }
        .toggle-children {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 5px;
            margin-right: 5px;
            font-size: 1em;
            color: #666;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px;
            margin: 0 2px;
            color: #2196F3;
        }
        .consolidated-indicator {
            margin-left: 5px;
            font-size: 0.8em;
            color: #2196F3;
            font-weight: normal;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Fund Accounting System</h1>
        <div class="header-right-controls">
            <div class="db-status-container">
                <span id="db-status-indicator" class="offline">DB Offline</span>
            </div>
            <div class="consolidated-view-container">
                <label for="consolidated-view-toggle">Consolidated View:</label>
                <input type="checkbox" id="consolidated-view-toggle">
            </div>
            <div class="entity-selector-container">
                <label for="entity-selector">Entity:</label>
                <select id="entity-selector">
                    <option value="">Loading Entities...</option>
                </select>
            </div>
            <div class="user-info"><span>User</span><button class="logout-button" id="btnLogout">Logout</button></div>
        </div>
    </div>

    <div class="main-content">
        <div class="main-nav">
            <div class="nav-item active" data-page="dashboard">Dashboard</div>
            <div class="nav-item" data-page="chart-of-accounts">Chart of Accounts</div>
            <div class="nav-item" data-page="funds">Funds</div>
            <div class="nav-item" data-page="journal-entries">Journal Entries</div>
            <div class="nav-item" data-page="settings">Settings</div>
        </div>

        <div class="content-area">
            <div id="dashboard-page" class="page active">
                <div class="content-header">
                    <h2 id="dashboard-title">Dashboard</h2>
                    <button class="action-button">Print Report</button>
                </div>
                <div class="card-grid" id="dashboard-summary-cards">
                    <!-- Cards will be dynamically loaded here -->
                </div>
                <h3 class="mt-20">Fund Balances</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fund Name</th>
                            <th>Type</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-fund-balances">
                        <!-- Fund balances will be dynamically loaded here -->
                    </tbody>
                </table>
                <h3>Recent Transactions</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-recent-transactions">
                        <!-- Recent transactions will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>

            <div id="chart-of-accounts-page" class="page hidden">
                <div class="content-header">
                    <h2>Chart of Accounts</h2>
                    <button class="action-button">Add Account</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="chart-of-accounts-table">
                        <!-- Chart of accounts will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>

            <div id="funds-page" class="page hidden">
                <div class="content-header">
                    <h2>Funds</h2>
                    <button class="action-button">Add Fund</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Entity</th>
                            <th>Balance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="funds-table">
                        <!-- Funds will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>

            <div id="journal-entries-page" class="page hidden">
                <div class="content-header">
                    <h2>Journal Entries</h2>
                    <button class="action-button">Add Journal Entry</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th>Entity</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="journal-entries-table">
                        <!-- Journal entries will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>

            <div id="settings-page" class="page hidden">
                <div class="content-header">
                    <h2>Settings</h2>
                </div>
                <div class="tab-container">
                    <div class="tab-nav">
                        <div class="tab-item active" data-tab="settings-general">General</div>
                        <div class="tab-item" data-tab="settings-entities">Entities</div>
                        <div class="tab-item" data-tab="settings-users">Users</div>
                    </div>
                    <div class="tab-content">
                        <div id="settings-general" class="tab-panel active">
                            <div class="settings-section">
                                <h3>System Settings</h3>
                                <label for="organization-name">Organization Name</label>
                                <input type="text" id="organization-name" value="The Principle Foundation">
                                <label for="fiscal-year-start">Fiscal Year Start</label>
                                <select id="fiscal-year-start">
                                    <option value="1">January</option>
                                    <option value="7" selected>July</option>
                                </select>
                                <button id="save-general-settings">Save Settings</button>
                            </div>
                        </div>
                        <div id="settings-entities" class="tab-panel">
                            <div class="settings-section">
                                <h3>Entity Management</h3>
                                <p>Manage the organizational structure and entity hierarchy.</p>
                                <button id="add-entity-btn" class="action-button">Add Entity</button>
                                
                                <h4 class="mt-20">Entity Hierarchy</h4>
                                <div id="entity-relationship-viz" class="hierarchy-visualization">
                                    <!-- Entity hierarchy will be dynamically loaded here -->
                                </div>
                                
                                <h4 class="mt-20">Entities</h4>
                                <table id="entities-table" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Code</th>
                                            <th>Parent</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Entities will be dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="settings-users" class="tab-panel">
                            <div class="settings-section">
                                <h3>User Management</h3>
                                <p>Manage system users and their permissions.</p>
                                <button id="add-user-btn" class="action-button">Add User</button>
                                
                                <h4 class="mt-20">Users</h4>
                                <table id="users-table" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Users will be dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Entity Edit Modal -->
    <div id="entity-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="entity-modal-title">Add Entity</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="entity-form">
                    <div class="form-group">
                        <label for="entity-name">Entity Name</label>
                        <input type="text" id="entity-name" required>
                    </div>
                    <div class="form-group">
                        <label for="entity-code">Entity Code</label>
                        <input type="text" id="entity-code" required>
                    </div>
                    <div class="form-group">
                        <label for="entity-parent">Parent Entity</label>
                        <select id="entity-parent">
                            <option value="">None (Top Level)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="entity-consolidated">Consolidates Children</label>
                        <input type="checkbox" id="entity-consolidated">
                    </div>
                    <div class="form-group">
                        <label for="entity-status">Status</label>
                        <select id="entity-status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <input type="hidden" id="entity-id">
                </form>
            </div>
            <div class="modal-footer">
                <button id="entity-save-btn" class="action-button">Save</button>
                <button id="entity-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const appState = {
            entities: [],
            funds: [],
            journalEntries: [],
            selectedEntityId: null,
            isConsolidatedView: false,
            currentPage: 'dashboard',
            currentTab: 'settings-general',
            dbConnected: false,
            entityTypes: {
                ROOT: 'root',
                ENTITY: 'entity',
                FUND: 'fund'
            }
        };

        // DOM Elements
        const elements = {
            dbStatusIndicator: document.getElementById('db-status-indicator'),
            consolidatedViewToggle: document.getElementById('consolidated-view-toggle'),
            entitySelector: document.getElementById('entity-selector'),
            navItems: document.querySelectorAll('.nav-item'),
            pages: document.querySelectorAll('.page'),
            tabItems: document.querySelectorAll('.tab-item'),
            tabPanels: document.querySelectorAll('.tab-panel'),
            dashboardTitle: document.getElementById('dashboard-title'),
            dashboardSummaryCards: document.getElementById('dashboard-summary-cards'),
            dashboardFundBalances: document.getElementById('dashboard-fund-balances'),
            dashboardRecentTransactions: document.getElementById('dashboard-recent-transactions'),
            entityRelationshipViz: document.getElementById('entity-relationship-viz'),
            entitiesTable: document.getElementById('entities-table').querySelector('tbody'),
            fundsTable: document.getElementById('funds-table'),
            journalEntriesTable: document.getElementById('journal-entries-table'),
            entityModal: document.getElementById('entity-modal'),
            entityForm: document.getElementById('entity-form'),
            entityParentSelect: document.getElementById('entity-parent')
        };

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }).format(date);
        }

        // API Functions
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                throw error;
            }
        }

        async function saveData(endpoint, data, method = 'POST') {
            try {
                const response = await fetch(`/api/${endpoint}`, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error saving to ${endpoint}:`, error);
                throw error;
            }
        }

        // Database Connection Check
        async function checkDatabaseConnection() {
            try {
                await fetchData('entities');
                elements.dbStatusIndicator.textContent = 'DB Connected';
                elements.dbStatusIndicator.classList.remove('offline');
                elements.dbStatusIndicator.classList.add('online');
                appState.dbConnected = true;
                return true;
            } catch (error) {
                elements.dbStatusIndicator.textContent = 'DB Offline';
                elements.dbStatusIndicator.classList.remove('online');
                elements.dbStatusIndicator.classList.add('offline');
                appState.dbConnected = false;
                return false;
            }
        }

        // Data Loading Functions
        async function loadEntityData() {
            try {
                const entities = await fetchData('entities');
                appState.entities = entities;
                
                // Update entity selector
                updateEntitySelector();
                
                // Update entity table
                updateEntitiesTable();
                
                // Update entity hierarchy visualization
                updateEntityHierarchy();
                
                return entities;
            } catch (error) {
                console.error('Error loading entity data:', error);
                return [];
            }
        }

        async function loadFundData() {
            try {
                const funds = await fetchData('funds');
                appState.funds = funds;
                
                // Update funds table
                updateFundsTable();
                
                return funds;
            } catch (error) {
                console.error('Error loading fund data:', error);
                return [];
            }
        }

        async function loadJournalEntryData() {
            try {
                const journalEntries = await fetchData('journal-entries');
                appState.journalEntries = journalEntries;
                
                // Update journal entries table
                updateJournalEntriesTable();
                
                return journalEntries;
            } catch (error) {
                console.error('Error loading journal entry data:', error);
                return [];
            }
        }

        async function loadDashboardData(isConsolidated = false) {
            try {
                // Update dashboard title based on selected entity
                updateDashboardTitle();
                
                // Load summary cards
                updateDashboardSummaryCards();
                
                // Load fund balances
                updateDashboardFundBalances();
                
                // Load recent transactions
                updateDashboardRecentTransactions();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // UI Update Functions
        function updateEntitySelector() {
            if (!appState.entities.length) return;
            
            elements.entitySelector.innerHTML = '';
            
            // Find TPF_PARENT entity (root)
            const rootEntity = appState.entities.find(entity => 
                entity.parent_entity_id === null && 
                (entity.name === 'The Principle Foundation' || entity.code === 'TPF_PARENT')
            );
            
            // Add root entity option
            if (rootEntity) {
                const option = document.createElement('option');
                option.value = rootEntity.id;
                option.textContent = `${rootEntity.name} (Consolidated)`;
                elements.entitySelector.appendChild(option);
            }
            
            // Add child entities
            const childEntities = appState.entities.filter(entity => 
                entity.parent_entity_id === rootEntity?.id
            );
            
            childEntities.forEach(entity => {
                const option = document.createElement('option');
                option.value = entity.id;
                option.textContent = entity.name;
                elements.entitySelector.appendChild(option);
            });
            
            // Set default selected entity
            if (!appState.selectedEntityId && rootEntity) {
                appState.selectedEntityId = rootEntity.id;
                elements.entitySelector.value = rootEntity.id;
            } else if (appState.selectedEntityId) {
                elements.entitySelector.value = appState.selectedEntityId;
            }
        }

        function updateDashboardTitle() {
            if (!appState.selectedEntityId) return;
            
            const selectedEntity = appState.entities.find(entity => entity.id === appState.selectedEntityId);
            if (selectedEntity) {
                elements.dashboardTitle.textContent = `${selectedEntity.name} Dashboard`;
                
                if (appState.isConsolidatedView && selectedEntity.is_consolidated) {
                    elements.dashboardTitle.textContent += ' (Consolidated)';
                }
            }
        }

        function updateDashboardSummaryCards() {
            if (!appState.selectedEntityId) return;
            
            // Get funds for the selected entity
            let relevantFunds = [];
            
            if (appState.isConsolidatedView) {
                // For consolidated view, get all funds from this entity and its children
                const selectedEntity = appState.entities.find(entity => entity.id === appState.selectedEntityId);
                
                if (selectedEntity && selectedEntity.is_consolidated) {
                    // Get all child entities
                    const childEntities = appState.entities.filter(entity => entity.parent_entity_id === selectedEntity.id);
                    const childEntityIds = childEntities.map(entity => entity.id);
                    
                    // Include funds from the parent and all children
                    relevantFunds = appState.funds.filter(fund => 
                        fund.entity_id === selectedEntity.id || childEntityIds.includes(fund.entity_id)
                    );
                } else {
                    // Just this entity's funds
                    relevantFunds = appState.funds.filter(fund => fund.entity_id === appState.selectedEntityId);
                }
            } else {
                // Non-consolidated view - just this entity's funds
                relevantFunds = appState.funds.filter(fund => fund.entity_id === appState.selectedEntityId);
            }
            
            // Calculate summary values
            const totalAssets = relevantFunds.reduce((sum, fund) => sum + (fund.balance || 0), 0);
            const totalLiabilities = relevantFunds.reduce((sum, fund) => {
                if (fund.type === 'Liability') {
                    return sum + (fund.balance || 0);
                }
                return sum;
            }, 0);
            const netAssets = totalAssets - totalLiabilities;
            
            // Calculate YTD revenue from journal entries
            let ytdRevenue = 0;
            if (appState.journalEntries.length) {
                const currentYear = new Date().getFullYear();
                const relevantEntityIds = appState.isConsolidatedView ? 
                    [appState.selectedEntityId, ...appState.entities
                        .filter(entity => entity.parent_entity_id === appState.selectedEntityId)
                        .map(entity => entity.id)] :
                    [appState.selectedEntityId];
                
                ytdRevenue = appState.journalEntries
                    .filter(entry => 
                        new Date(entry.entry_date).getFullYear() === currentYear &&
                        relevantEntityIds.includes(entry.entity_id) &&
                        entry.type === 'Revenue'
                    )
                    .reduce((sum, entry) => sum + (entry.total_amount || 0), 0);
            }
            
            // Update the cards
            elements.dashboardSummaryCards.innerHTML = `
                <div class="card">
                    <div class="card-title">Total Assets</div>
                    <div class="card-value">${formatCurrency(totalAssets)}</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Liabilities</div>
                    <div class="card-value">${formatCurrency(totalLiabilities)}</div>
                </div>
                <div class="card">
                    <div class="card-title">Net Assets</div>
                    <div class="card-value">${formatCurrency(netAssets)}</div>
                </div>
                <div class="card">
                    <div class="card-title">YTD Revenue</div>
                    <div class="card-value">${formatCurrency(ytdRevenue)}</div>
                </div>
            `;
        }

        function updateDashboardFundBalances() {
            if (!appState.selectedEntityId) return;
            
            // Get funds for the selected entity
            let relevantFunds = [];
            
            if (appState.isConsolidatedView) {
                // For consolidated view, get all funds from this entity and its children
                const selectedEntity = appState.entities.find(entity => entity.id === appState.selectedEntityId);
                
                if (selectedEntity && selectedEntity.is_consolidated) {
                    // Get all child entities
                    const childEntities = appState.entities.filter(entity => entity.parent_entity_id === selectedEntity.id);
                    const childEntityIds = childEntities.map(entity => entity.id);
                    
                    // Include funds from the parent and all children
                    relevantFunds = appState.funds.filter(fund => 
                        fund.entity_id === selectedEntity.id || childEntityIds.includes(fund.entity_id)
                    );
                } else {
                    // Just this entity's funds
                    relevantFunds = appState.funds.filter(fund => fund.entity_id === appState.selectedEntityId);
                }
            } else {
                // Non-consolidated view - just this entity's funds
                relevantFunds = appState.funds.filter(fund => fund.entity_id === appState.selectedEntityId);
            }
            
            // Sort funds by balance (descending)
            relevantFunds.sort((a, b) => (b.balance || 0) - (a.balance || 0));
            
            // Calculate total for percentage
            const totalBalance = relevantFunds.reduce((sum, fund) => sum + (fund.balance || 0), 0);
            
            // Update the fund balances table
            elements.dashboardFundBalances.innerHTML = '';
            
            if (relevantFunds.length === 0) {
                elements.dashboardFundBalances.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center;">No funds found</td>
                    </tr>
                `;
                return;
            }
            
            relevantFunds.forEach(fund => {
                const entityName = appState.entities.find(entity => entity.id === fund.entity_id)?.name || 'Unknown';
                const percentage = totalBalance ? ((fund.balance || 0) / totalBalance * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fund.name} ${appState.isConsolidatedView ? `(${entityName})` : ''}</td>
                    <td>${fund.type || 'N/A'}</td>
                    <td>${formatCurrency(fund.balance || 0)}</td>
                `;
                elements.dashboardFundBalances.appendChild(row);
            });
        }

        function updateDashboardRecentTransactions() {
            if (!appState.selectedEntityId) return;
            
            // Get journal entries for the selected entity
            let relevantEntries = [];
            
            if (appState.isConsolidatedView) {
                // For consolidated view, get entries from this entity and its children
                const selectedEntity = appState.entities.find(entity => entity.id === appState.selectedEntityId);
                
                if (selectedEntity && selectedEntity.is_consolidated) {
                    // Get all child entities
                    const childEntities = appState.entities.filter(entity => entity.parent_entity_id === selectedEntity.id);
                    const childEntityIds = childEntities.map(entity => entity.id);
                    
                    // Include entries from the parent and all children
                    relevantEntries = appState.journalEntries.filter(entry => 
                        entry.entity_id === selectedEntity.id || childEntityIds.includes(entry.entity_id)
                    );
                } else {
                    // Just this entity's entries
                    relevantEntries = appState.journalEntries.filter(entry => entry.entity_id === appState.selectedEntityId);
                }
            } else {
                // Non-consolidated view - just this entity's entries
                relevantEntries = appState.journalEntries.filter(entry => entry.entity_id === appState.selectedEntityId);
            }
            
            // Sort entries by date (most recent first)
            relevantEntries.sort((a, b) => new Date(b.entry_date) - new Date(a.entry_date));
            
            // Take only the 5 most recent
            const recentEntries = relevantEntries.slice(0, 5);
            
            // Update the recent transactions table
            elements.dashboardRecentTransactions.innerHTML = '';
            
            if (recentEntries.length === 0) {
                elements.dashboardRecentTransactions.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center;">No recent transactions</td>
                    </tr>
                `;
                return;
            }
            
            recentEntries.forEach(entry => {
                const entityName = appState.entities.find(entity => entity.id === entry.entity_id)?.name || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.entry_date)}</td>
                    <td>${entry.reference_number || 'N/A'}</td>
                    <td>${entry.description || 'N/A'} ${appState.isConsolidatedView ? `(${entityName})` : ''}</td>
                    <td>${formatCurrency(entry.total_amount || 0)}</td>
                    <td><span class="status status-${entry.status.toLowerCase()}">${entry.status}</span></td>
                `;
                elements.dashboardRecentTransactions.appendChild(row);
            });
        }

        function updateFundsTable() {
            if (!appState.funds.length) return;
            
            // 'funds-table' *is* the tbody element, so we can reference it directly
            const fundsTableBody = document.getElementById('funds-table');
            fundsTableBody.innerHTML = '';
            
            let displayFunds = appState.funds;
            
            // Filter by selected entity if not in consolidated view
            if (appState.selectedEntityId && !appState.isConsolidatedView) {
                displayFunds = appState.funds.filter(fund => fund.entity_id === appState.selectedEntityId);
            } else if (appState.selectedEntityId && appState.isConsolidatedView) {
                // In consolidated view, show funds for the selected entity and its children
                const selectedEntity = appState.entities.find(entity => entity.id === appState.selectedEntityId);
                
                if (selectedEntity && selectedEntity.is_consolidated) {
                    const childEntityIds = appState.entities
                        .filter(entity => entity.parent_entity_id === selectedEntity.id)
                        .map(entity => entity.id);
                    
                    displayFunds = appState.funds.filter(fund => 
                        fund.entity_id === selectedEntity.id || childEntityIds.includes(fund.entity_id)
                    );
                } else {
                    displayFunds = appState.funds.filter(fund => fund.entity_id === appState.selectedEntityId);
                }
            }
            
            // Sort by entity and then by fund name
            displayFunds.sort((a, b) => {
                const entityA = appState.entities.find(entity => entity.id === a.entity_id)?.name || '';
                const entityB = appState.entities.find(entity => entity.id === b.entity_id)?.name || '';
                
                if (entityA !== entityB) {
                    return entityA.localeCompare(entityB);
                }
                return a.name.localeCompare(b.name);
            });
            
            displayFunds.forEach(fund => {
                const entityName = appState.entities.find(entity => entity.id === fund.entity_id)?.name || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fund.code || 'N/A'}</td>
                    <td>${fund.name}</td>
                    <td>${fund.type || 'N/A'}</td>
                    <td>${entityName}</td>
                    <td>${formatCurrency(fund.balance || 0)}</td>
                    <td>${fund.status || 'Active'}</td>
                `;
                fundsTableBody.appendChild(row);
            });
        }

        function updateJournalEntriesTable() {
            if (!appState.journalEntries.length) return;
            
            // 'journal-entries-table' is the tbody element
            const journalEntriesTableBody = document.getElementById('journal-entries-table');
            journalEntriesTableBody.innerHTML = '';
            
            let displayEntries = appState.journalEntries;
            
            // Filter by selected entity if not in consolidated view
            if (appState.selectedEntityId && !appState.isConsolidatedView) {
                displayEntries = appState.journalEntries.filter(entry => entry.entity_id === appState.selectedEntityId);
            } else if (appState.selectedEntityId && appState.isConsolidatedView) {
                // In consolidated view, show entries for the selected entity and its children
                const selectedEntity = appState.entities.find(entity => entity.id === appState.selectedEntityId);
                
                if (selectedEntity && selectedEntity.is_consolidated) {
                    const childEntityIds = appState.entities
                        .filter(entity => entity.parent_entity_id === selectedEntity.id)
                        .map(entity => entity.id);
                    
                    displayEntries = appState.journalEntries.filter(entry => 
                        entry.entity_id === selectedEntity.id || childEntityIds.includes(entry.entity_id)
                    );
                } else {
                    displayEntries = appState.journalEntries.filter(entry => entry.entity_id === appState.selectedEntityId);
                }
            }
            
            // Sort by date (most recent first)
            displayEntries.sort((a, b) => new Date(b.entry_date) - new Date(a.entry_date));
            
            displayEntries.forEach(entry => {
                const entityName = appState.entities.find(entity => entity.id === entry.entity_id)?.name || 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.entry_date)}</td>
                    <td>${entry.reference_number || 'N/A'}</td>
                    <td>${entry.description || 'N/A'}</td>
                    <td>${entityName}</td>
                    <td>${formatCurrency(entry.total_amount || 0)}</td>
                    <td><span class="status status-${entry.status.toLowerCase()}">${entry.status}</span></td>
                `;
                journalEntriesTableBody.appendChild(row);
            });
        }

        function updateEntitiesTable() {
            if (!appState.entities.length) return;
            
            elements.entitiesTable.innerHTML = '';
            
            appState.entities.forEach(entity => {
                // Find parent entity name
                let parentName = 'None';
                if (entity.parent_entity_id) {
                    const parent = appState.entities.find(e => e.id === entity.parent_entity_id);
                    if (parent) {
                        parentName = parent.name;
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entity.name}</td>
                    <td>${entity.code}</td>
                    <td>${parentName}</td>
                    <td>${entity.status || 'Active'}</td>
                    <td>
                        <button class="btn-edit" data-id="${entity.id}">Edit</button>
                        <button class="btn-delete" data-id="${entity.id}">Delete</button>
                    </td>
                `;
                elements.entitiesTable.appendChild(row);
            });
            
            // Add event listeners to edit/delete buttons
            elements.entitiesTable.querySelectorAll('.btn-edit').forEach(button => {
                button.addEventListener('click', () => openEntityModal(button.dataset.id));
            });
            
            elements.entitiesTable.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', () => deleteEntity(button.dataset.id));
            });
        }

        function updateEntityHierarchy() {
            if (!appState.entities.length || !elements.entityRelationshipViz) return;
            
            // Clear the container
            elements.entityRelationshipViz.innerHTML = '';
            
            // Build hierarchy data
            const hierarchyData = buildHierarchyData();
            
            // Create hierarchy visualization
            if (hierarchyData.root) {
                const rootNode = createHierarchyNode(hierarchyData.root);
                elements.entityRelationshipViz.appendChild(rootNode);
            } else {
                elements.entityRelationshipViz.innerHTML = '<p>No entity hierarchy found.</p>';
            }
        }

        function buildHierarchyData() {
            // Create entity map for quick lookup
            const entityMap = {};
            appState.entities.forEach(entity => {
                entityMap[entity.id] = {
                    ...entity,
                    type: appState.entityTypes.ENTITY,
                    children: []
                };
            });
            
            // Find root entity (TPF_PARENT)
            const rootEntity = appState.entities.find(entity => 
                entity.parent_entity_id === null && 
                (entity.name === 'The Principle Foundation' || entity.code === 'TPF_PARENT')
            );
            
            // If no specific root, use any entity without a parent
            const fallbackRoot = rootEntity || appState.entities.find(entity => entity.parent_entity_id === null);
            
            // Build the hierarchy
            const hierarchy = {
                root: fallbackRoot ? entityMap[fallbackRoot.id] : null,
                entities: entityMap
            };
            
            // Add child entities to their parents
            appState.entities.forEach(entity => {
                if (entity.parent_entity_id && entityMap[entity.parent_entity_id]) {
                    entityMap[entity.parent_entity_id].children.push(entityMap[entity.id]);
                }
            });
            
            // Add funds to their respective entities
            appState.funds.forEach(fund => {
                const fundObj = {
                    ...fund,
                    type: appState.entityTypes.FUND,
                    children: []
                };
                
                if (entityMap[fund.entity_id]) {
                    entityMap[fund.entity_id].children.push(fundObj);
                }
            });
            
            return hierarchy;
        }

        function createHierarchyNode(node) {
            if (!node) return null;
            
            const nodeContainer = document.createElement('div');
            nodeContainer.className = `hierarchy-node ${node.type === appState.entityTypes.FUND ? 'fund-node' : 'entity-node'}`;
            nodeContainer.dataset.id = node.id;
            nodeContainer.dataset.type = node.type;
            
            // Create node header
            const nodeHeader = document.createElement('div');
            nodeHeader.className = 'node-header';
            
            // Create node title
            const nodeTitle = document.createElement('div');
            nodeTitle.className = 'node-title';
            nodeTitle.textContent = `${node.name} (${node.code})`;
            
            // Create consolidated indicator if applicable
            if (node.type !== appState.entityTypes.FUND && node.is_consolidated) {
                const consolidatedIndicator = document.createElement('span');
                consolidatedIndicator.className = 'consolidated-indicator';
                consolidatedIndicator.title = 'This entity consolidates its children';
                consolidatedIndicator.textContent = ' [Consolidated]';
                nodeTitle.appendChild(consolidatedIndicator);
            }
            
            // Create node actions
            const nodeActions = document.createElement('div');
            nodeActions.className = 'node-actions';
            
            // Add edit button for entities
            if (node.type === appState.entityTypes.ENTITY) {
                const editButton = document.createElement('button');
                editButton.className = 'btn-icon edit-entity';
                editButton.innerHTML = '✏️';
                editButton.title = 'Edit Entity';
                editButton.addEventListener('click', () => openEntityModal(node.id));
                nodeActions.appendChild(editButton);
            }
            
            // Add children if any
            if (node.children && node.children.length > 0) {
                // Create toggle button for expanding/collapsing
                const toggleButton = document.createElement('button');
                toggleButton.className = 'toggle-children';
                toggleButton.textContent = '▼';
                
                // Create children container
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'node-children';
                
                toggleButton.addEventListener('click', () => {
                    childrenContainer.classList.toggle('collapsed');
                    toggleButton.textContent = childrenContainer.classList.contains('collapsed') ? '►' : '▼';
                });
                
                // Sort children: entities first, then funds
                const entityChildren = node.children.filter(child => child.type === appState.entityTypes.ENTITY);
                const fundChildren = node.children.filter(child => child.type === appState.entityTypes.FUND);
                
                // Add entity children
                entityChildren.forEach(child => {
                    const childNode = createHierarchyNode(child);
                    if (childNode) {
                        childrenContainer.appendChild(childNode);
                    }
                });
                
                // Add fund children
                fundChildren.forEach(child => {
                    const childNode = createHierarchyNode(child);
                    if (childNode) {
                        childrenContainer.appendChild(childNode);
                    }
                });
                
                // Only add toggle and children container if there are actually children
                if (childrenContainer.children.length > 0) {
                    nodeHeader.insertBefore(toggleButton, nodeHeader.firstChild);
                    nodeContainer.appendChild(childrenContainer);
                }
            }
            
            // Assemble the node
            nodeHeader.appendChild(nodeTitle);
            nodeHeader.appendChild(nodeActions);
            nodeContainer.insertBefore(nodeHeader, nodeContainer.firstChild);
            
            return nodeContainer;
        }

        // Entity Modal Functions
        function openEntityModal(entityId = null) {
            // Clear form
            document.getElementById('entity-form').reset();
            document.getElementById('entity-id').value = '';
            
            // Populate parent entity dropdown
            populateParentEntityDropdown(entityId);
            
            if (entityId) {
                // Edit mode
                const entity = appState.entities.find(e => e.id === entityId);
                if (entity) {
                    document.getElementById('entity-modal-title').textContent = 'Edit Entity';
                    document.getElementById('entity-name').value = entity.name;
                    document.getElementById('entity-code').value = entity.code;
                    document.getElementById('entity-parent').value = entity.parent_entity_id || '';
                    document.getElementById('entity-consolidated').checked = entity.is_consolidated || false;
                    document.getElementById('entity-status').value = entity.status || 'active';
                    document.getElementById('entity-id').value = entity.id;
                }
            } else {
                // Add mode
                document.getElementById('entity-modal-title').textContent = 'Add Entity';
            }
            
            // Show modal
            elements.entityModal.classList.remove('hidden');
        }

        function populateParentEntityDropdown(currentEntityId = null) {
            const parentSelect = document.getElementById('entity-parent');
            parentSelect.innerHTML = '<option value="">None (Top Level)</option>';
            
            // Add all entities except the current one being edited
            appState.entities.forEach(entity => {
                if (entity.id !== currentEntityId) {
                    const option = document.createElement('option');
                    option.value = entity.id;
                    option.textContent = entity.name;
                    parentSelect.appendChild(option);
                }
            });
        }

        async function saveEntity() {
            const entityId = document.getElementById('entity-id').value;
            const entityData = {
                name: document.getElementById('entity-name').value,
                code: document.getElementById('entity-code').value,
                parent_entity_id: document.getElementById('entity-parent').value || null,
                is_consolidated: document.getElementById('entity-consolidated').checked,
                status: document.getElementById('entity-status').value
            };
            
            try {
                let savedEntity;
                
                if (entityId) {
                    // Update existing entity
                    savedEntity = await saveData(`entities/${entityId}`, entityData, 'PUT');
                } else {
                    // Create new entity
                    savedEntity = await saveData('entities', entityData);
                }
                
                // Close modal
                elements.entityModal.classList.add('hidden');
                
                // Reload entity data
                await loadEntityData();
                
                return savedEntity;
            } catch (error) {
                console.error('Error saving entity:', error);
                alert('Error saving entity: ' + error.message);
                return null;
            }
        }

        async function deleteEntity(entityId) {
            if (!confirm('Are you sure you want to delete this entity?')) {
                return;
            }
            
            try {
                // Check if entity has children
                const hasChildren = appState.entities.some(entity => entity.parent_entity_id === entityId);
                if (hasChildren) {
                    alert('Cannot delete entity with child entities. Please delete or reassign child entities first.');
                    return;
                }
                
                // Check if entity has funds
                const hasFunds = appState.funds.some(fund => fund.entity_id === entityId);
                if (hasFunds) {
                    alert('Cannot delete entity with funds. Please delete or reassign funds first.');
                    return;
                }
                
                // Delete entity
                await fetch(`/api/entities/${entityId}`, { method: 'DELETE' });
                
                // Reload entity data
                await loadEntityData();
                
                alert('Entity deleted successfully.');
            } catch (error) {
                console.error('Error deleting entity:', error);
                alert('Error deleting entity: ' + error.message);
            }
        }

        // Navigation Functions
        function navigateTo(page) {
            // Hide all pages
            elements.pages.forEach(p => p.classList.add('hidden'));
            
            // Show selected page
            const selectedPage = document.getElementById(`${page}-page`);
            if (selectedPage) {
                selectedPage.classList.remove('hidden');
            }
            
            // Update active nav item
            elements.navItems.forEach(item => {
                if (item.dataset.page === page) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Update current page in state
            appState.currentPage = page;
            
            // Refresh page data
            refreshPageData(page);
        }

        function switchTab(tabId) {
            // Hide all tab panels
            elements.tabPanels.forEach(panel => panel.classList.remove('active'));
            
            // Show selected tab panel
            const selectedPanel = document.getElementById(tabId);
            if (selectedPanel) {
                selectedPanel.classList.add('active');
            }
            
            // Update active tab item
            elements.tabItems.forEach(item => {
                if (item.dataset.tab === tabId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Update current tab in state
            appState.currentTab = tabId;
            
            // Refresh tab data
            refreshTabData(tabId);
        }

        function refreshPageData(page) {
            switch (page) {
                case 'dashboard':
                    loadDashboardData(appState.isConsolidatedView);
                    break;
                case 'chart-of-accounts':
                    // Placeholder for chart of accounts refresh
                    break;
                case 'funds':
                    updateFundsTable();
                    break;
                case 'journal-entries':
                    updateJournalEntriesTable();
                    break;
                case 'settings':
                    // Refresh current tab
                    refreshTabData(appState.currentTab);
                    break;
            }
        }

        function refreshTabData(tabId) {
            switch (tabId) {
                case 'settings-entities':
                    updateEntitiesTable();
                    updateEntityHierarchy();
                    break;
                case 'settings-users':
                    // Placeholder for users tab refresh
                    break;
                case 'settings-general':
                    // Placeholder for general settings tab refresh
                    break;
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            elements.navItems.forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.page));
            });
            
            // Tab switching
            elements.tabItems.forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });
            
            // Entity selector change
            elements.entitySelector.addEventListener('change', () => {
                appState.selectedEntityId = elements.entitySelector.value;
                refreshPageData(appState.currentPage);
            });
            
            // Consolidated view toggle
            elements.consolidatedViewToggle.addEventListener('change', () => {
                appState.isConsolidatedView = elements.consolidatedViewToggle.checked;
                refreshPageData(appState.currentPage);
            });
            
            // Entity modal
            document.getElementById('add-entity-btn').addEventListener('click', () => openEntityModal());
            document.getElementById('entity-save-btn').addEventListener('click', saveEntity);
            document.getElementById('entity-cancel-btn').addEventListener('click', () => elements.entityModal.classList.add('hidden'));
            document.querySelector('.close-modal').addEventListener('click', () => elements.entityModal.classList.add('hidden'));
        }

        // Initialization
        async function initializeApp() {
            // Check database connection
            const dbConnected = await checkDatabaseConnection();
            if (!dbConnected) {
                console.error('Database connection failed. Please check server status.');
                return;
            }
            
            // Load initial data
            await Promise.all([
                loadEntityData(),
                loadFundData(),
                loadJournalEntryData()
            ]);
            
            // Set up event listeners
            setupEventListeners();
            
            // Load dashboard data
            loadDashboardData();
            
            console.log('Application initialized successfully.');
        }

        // Start the application when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
